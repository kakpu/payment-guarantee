# CLAUDE.md — プロジェクトルール

このファイルは Claude Code がプロジェクト作業時に従うべきルールと方針を定義します。

---

## プロジェクト概要

**代弁実行（保証審査）書類取込・確認アプリ**

地銀オペレーターが代弁実行に必要な本人確認書類（マイナンバーカード・運転免許証）を取り込み、
AI OCR で抽出した情報を確認・修正し、確定データを代弁実行システムへ日次バッチ連携するアプリ。

- 対象ユーザー：地方銀行オペレーター（〜100人）
- 開発規模：個人開発
- 設計書は `docs/` 配下に配置（変更前に必ず参照すること）

```
docs/
├── 01_requirements.md   # 要件定義
├── 02_architecture.md   # アーキテクチャ設計
├── 03_database.md       # データベース設計
├── 04_api.md            # API設計
└── 05_sitemap.md        # サイトマップ・画面遷移
```

---

## 回答言語

**回答・コメント・コミットメッセージはすべて日本語で記述すること。**

- コード内のコメントも日本語
- エラーメッセージや説明文も日本語
- 英語が適切な場面（技術用語、ライブラリ名など）はそのまま英語を使用してよい

---

## コミットメッセージのフォーマット

[Conventional Commits](https://www.conventionalcommits.org/) に準拠し、説明は日本語で記述する。

### 形式

```
<タイプ>(<スコープ>): <変更の概要（日本語）>

<本文（任意）>

<フッター（任意）>
```

### タイプ一覧

| タイプ     | 用途                                   |
|----------|--------------------------------------|
| `feat`   | 新機能の追加                             |
| `fix`    | バグ修正                                |
| `docs`   | ドキュメントのみの変更                     |
| `style`  | コードの動作に影響しない変更（フォーマット等）  |
| `refactor` | バグ修正・機能追加を伴わないリファクタリング |
| `test`   | テストの追加・修正                        |
| `chore`  | ビルド・CI・設定ファイルの変更              |

### スコープ例

`ocr`, `ui`, `batch`, `api`, `db`, `auth`, `docs`

### 記述例

```
feat(ocr): マイナンバーカードのOCR情報抽出処理を実装

AWS TextractでのOCR結果から氏名・生年月日・住所を抽出するロジックを追加。
エラー時はOCR実行日時とともにDBへ記録する。
```

```
fix(batch): 日次バッチが0件の場合にクラッシュする問題を修正
```

```
docs: 03_database.md にusersテーブルのDDLを追記
```

---

## コード・ドキュメント生成のスタイルルール

### 全般

- **既存のスタイルや命名規則を尊重する。** 変更前にファイルを必ず読むこと。
- Lintルール（ESLint / Prettier 等）が設定されている場合は必ずそれに従う。
- 不必要なファイルを新規作成しない。既存ファイルの編集を優先する。
- 設定値・外部URL・表示名などは `config.ts` 等の一箇所に集約する（`05_sitemap.md` 参照）。

### コメント

- 自明でないロジックにのみコメントを付ける（自明なコードへのコメントは不要）。
- コメントは日本語で記述する。
- `TODO:` / `FIXME:` は日本語で理由も添える。

```typescript
// TODO: 将来的に手動バッチ実行にも対応（03_requirements.md 3.3参照）
```

### TypeScript / JavaScript

- 型安全を最優先とし、`any` は原則禁止。
- 関数の引数・戻り値には型注釈を付ける。
- `null` / `undefined` の扱いは明示的に行う。

### API設計

- RESTful に従う（`04_api.md` 参照）。
- エラーレスポンスは全エンドポイントで統一したフォーマットを使う。
- 認証が必要なエンドポイントは必ずその旨をコメントで明示する。

### データベース

- カラム名・テーブル名は `03_database.md` の定義に従う。
- マイグレーションを手書きで変更しない。マイグレーションファイルを正しく生成する。

---

## Claude が意識すべき観点

### 個人情報・セキュリティ

本アプリは **本人確認書類（マイナンバーカード・運転免許証）を扱う金融系アプリ** であるため、
セキュリティには特に注意する。

- 書類画像は S3 等のクラウドに保存し、**DB には画像リンク（オブジェクトキー）のみ保持**する。
- 個人情報（氏名・生年月日・住所）をログに出力しない。
- SQL インジェクション・XSS・CSRF 等の OWASP Top 10 脆弱性を作り込まない。
- 認証が必要な操作に認証チェックを漏らさない。

### 監査対応

- 操作者 ID・確認日時・変更前後の値は必ず記録する（`01_requirements.md` 2.2 参照）。
- 変更履歴を破壊する処理（物理削除など）は慎重に扱い、論理削除を優先する。

### MVP 優先

- 将来機能（権限管理・画像拡大・リアルタイム連携等）は `01_requirements.md` の「将来機能」として定義済み。
- **MVP に含まれていない機能を勝手に追加しない。**
- 設計書に記載のない拡張は実装前にユーザーに確認する。

### 冗長なコードの回避

- 3 行以上で繰り返すロジックは関数・モジュールに切り出す。
- ただし、1 回しか使わない処理のために過剰な抽象化をしない（YAGNI 原則）。
- `if-else` の深いネストは早期 return やガード節で回避する。

### 設計書との整合性

コードを書く前に必ず関連する設計書を参照し、定義と一致していることを確認する。

| 作業内容              | 参照すべき設計書                   |
|--------------------|-------------------------------|
| 画面・URL の追加      | `05_sitemap.md`               |
| API エンドポイントの追加 | `04_api.md`                   |
| テーブル・カラムの追加   | `03_database.md`              |
| 機能の追加・変更       | `01_requirements.md`          |
| インフラ・技術選定      | `02_architecture.md`          |

---

## 禁止事項

- `git push --force` を確認なしに実行しない
- `.env` やシークレット情報をコードにハードコードしない
- 個人情報をログ・コンソールに出力するコードを書かない
- 設計書に定義されていないテーブルやエンドポイントを無断で追加しない
- ユーザーの確認なしに既存の動作を破壊的に変更しない
