name: 日次バッチエクスポート

on:
  # 毎日 JST 20:00 (UTC 11:00) に自動実行
  schedule:
    - cron: '0 11 * * *'

  # GitHub ActionsのUIから手動実行も可能
  workflow_dispatch:

jobs:
  batch-export:
    name: バッチCSVエクスポート実行
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: バッチEdge Functionを呼び出す
        run: |
          RESPONSE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/batch-export" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          echo "HTTP Status: $RESPONSE"
          echo "Response body:"
          cat /tmp/response.json

          if [ "$RESPONSE" != "200" ]; then
            echo "バッチ処理が失敗しました（HTTP $RESPONSE）"
            exit 1
          fi

          # successフラグを確認
          SUCCESS=$(cat /tmp/response.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('success','false'))")
          if [ "$SUCCESS" != "True" ]; then
            echo "バッチ処理がエラーで終了しました"
            cat /tmp/response.json
            exit 1
          fi

          echo "バッチ処理が正常に完了しました"
          cat /tmp/response.json
