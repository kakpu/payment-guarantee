# 代弁実行（保証審査）書類取込・確認アプリ 要件定義

---

## 1. アプリ概要

### ■ 目的
地銀オペレーターが代弁実行に必要な本人確認書類を取り込み、
AI OCRで抽出した情報を確認・修正し、
確定データを代弁実行システムへバッチ連携できるようにする。

- 処理時間短縮
- 入力ミス削減
- 操作履歴の監査対応

---

### ■ ターゲット
- 地方銀行オペレーター（既存ログイン基盤利用）
- 権限管理者

---

### ■ 規模
- 個人開発
- 想定ユーザー数：〜100人

---

# 2. MVP機能

---

## 2.1 AI OCRによる書類取り込み・情報抽出

### ■ 対象書類
- マイナンバーカード
- 運転免許証

### ■ 抽出必須項目（共通）
- 氏名
- 生年月日
- 住所

### ■ 使用サービス
- **Google Cloud Vision API**（DOCUMENT_TEXT_DETECTION）
- 無料枠：1,000 ユニット/月
- 上限超過・API エラー時は**手動入力へフォールバック**（空欄で詳細画面を開く）

### ■ OCR 処理フロー
1. アップロード完了後、フロントエンドから OCR Edge Function を呼び出す
2. Edge Function が Storage の署名付きURL を発行し、Vision API へ送信
3. Vision API レスポンスから氏名・生年月日・住所をパース
4. `document_data` を更新し、`documents.status` を `ocr_completed` へ変更
5. 失敗時は `documents.status` を `uploaded` に戻し、`document_data.ocr_error_message` にエラー内容を記録

### ■ フォールバック
- 上限超過（HTTP 429）・API エラー時はエラーメッセージを Toast で表示
- 書類詳細画面を空欄で開き、オペレーターが手動入力する

### ■ 画像保存方針
- 書類画像は Supabase Storage（private バケット）へ保存
- DBには画像リンク（オブジェクトキー）のみ保持

---

## 2.2 確認・修正UI機能

### ■ 画面構成
- 左：書類画像表示
- 右：OCR抽出結果入力欄

### ■ 操作
- 確認OK確定
- 差戻し

### ■ 履歴管理
- 操作者ID
- 確認日時
- 更新履歴（変更前後）

---

## 2.3 代弁実行システムへの日次バッチ連携

### ■ 対象
当日「OK確定」になった案件

### ■ 連携項目
- 案件ID
- 書類種別
- 氏名
- 生年月日
- 住所
- 書類画像リンク
- 確認者ID
- 確認日時
- OCR実行日時（監査用）

### ■ 連携タイミング
- 毎日定時実行（例：20:00）

※MVPでは手動実行は必須ではない

---

# 3. 将来機能

---

## 3.1 権限管理マスター・再鑑機能

- 業務別アクセス制御
- ロール管理
  - オペレーター（書類アップロード・編集・確認）
  - 再鑑者（他ユーザーの書類を再鑑・訂正コメント付き差戻し）
  - 管理者
  - 監査閲覧専用

---

## 3.2 UI機能強化

- 画像拡大
- 画像回転
- 書類種別ごとの追加項目（例：免許証番号）
- 書類間整合チェック
- フォーマットバリデーション強化

---

## 3.3 バッチ連携高度化

- 手動バッチ実行
- APIリアルタイム連携
- リトライ・再送制御
- 連携結果可視化ダッシュボード
- エラー管理ワークフロー